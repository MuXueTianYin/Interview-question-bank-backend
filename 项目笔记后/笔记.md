# ç”¨æˆ·åŠŸèƒ½æ‹“å±•

## æœ¬èŠ‚é‡ç‚¹

é¢å‘ç”¨æˆ·çš„æ‰©å±•åŠŸèƒ½

- ç”¨æˆ·åˆ·é¢˜è®°å½•æ—¥å†ï¼šéœ€æ±‚åˆ†æ + æ–¹æ¡ˆè®¾è®¡ + å‰åç«¯å¼€å‘ + æ€§èƒ½ä¼˜åŒ–
- åˆ†è¯é¢˜ç›®æœç´¢ï¼šéœ€æ±‚åˆ†æ + æ–¹æ¡ˆè®¾è®¡ + å‰åç«¯å¼€å‘

## ä¸€ã€ç”¨æˆ·åˆ·é¢˜è®°å½•æ—¥å†

### éœ€æ±‚åˆ†æ

ä¸ºäº†é¼“åŠ±ç”¨æˆ·å¤šåœ¨ç½‘ç«™ä¸Šåˆ·é¢˜ï¼Œå¹¶ä¸”èƒ½è‡ªä¸»å¤ç›˜å­¦ä¹ æƒ…å†µï¼Œå¢åŠ æˆå°±æ„Ÿï¼Œéœ€è¦æ”¯æŒç”¨æˆ·åˆ·é¢˜è®°å½•æ—¥å†åŠŸèƒ½ã€‚

æ¯ä¸ªç”¨æˆ·æœ‰è‡ªå·±çš„ç­¾åˆ°è®°å½•ï¼Œå…·ä½“æ‹†è§£ä¸º 2 ä¸ªå­éœ€æ±‚ï¼š

1. ç”¨æˆ·æ¯æ—¥é¦–æ¬¡æµè§ˆé¢˜ç›®ï¼Œç®—ä½œæ˜¯ç­¾åˆ°ï¼Œä¼šè®°å½•åœ¨ç³»ç»Ÿä¸­ã€‚
2. ç”¨æˆ·å¯ä»¥åœ¨å‰ç«¯ä»¥å›¾è¡¨çš„å½¢å¼æŸ¥çœ‹è‡ªå·±åœ¨ **æŸä¸ªå¹´ä»½** çš„åˆ·é¢˜ç­¾åˆ°è®°å½•ï¼ˆæ¯å¤©æ˜¯å¦æœ‰ç­¾åˆ°ï¼‰ã€‚

### æ–¹æ¡ˆè®¾è®¡

åç«¯å®ç°å…³é”®åœ¨äºå¦‚ä½•å¿«é€Ÿå­˜å‚¨å’Œè·å–åˆ·é¢˜è®°å½•ï¼›å‰ç«¯å®ç°å…³é”®åœ¨äºå¦‚ä½•å±•ç¤ºåˆ·é¢˜è®°å½•ã€‚

#### åç«¯æ–¹æ¡ˆ - åŸºäºæ•°æ®åº“

åœ¨æ•°æ®åº“ä¸­è®¾è®¡ä¸€å¼ ç­¾åˆ°è¡¨ï¼Œè®°å½•ç”¨æˆ·æ¯æ¬¡ç­¾åˆ°çš„æ—¥æœŸåŠå…¶ä»–ç›¸å…³ä¿¡æ¯ã€‚ç„¶åé€šè¿‡æ—¶é—´èŒƒå›´æŸ¥è¯¢å¾—åˆ°ç”¨æˆ·çš„ç­¾åˆ°è®°å½•ã€‚

ç¤ºä¾‹è¡¨ç»“æ„å¦‚ä¸‹ï¼š

```sql
CREATE TABLE user_sign_in (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,  -- ä¸»é”®ï¼Œè‡ªåŠ¨é€’å¢
  userId BIGINT NOT NULL,               -- ç”¨æˆ·IDï¼Œå…³è”ç”¨æˆ·è¡¨
  signDate DATE NOT NULL,            -- ç­¾åˆ°æ—¥æœŸ
  createdTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  -- è®°å½•åˆ›å»ºæ—¶é—´
  UNIQUE KEY uq_user_date (userId, signDate)  -- ç”¨æˆ·IDå’Œç­¾åˆ°æ—¥æœŸçš„å”¯ä¸€æ€§çº¦æŸ
);
```

é€šè¿‡å”¯ä¸€ç´¢å¼•ï¼Œå¯ä»¥ç¡®ä¿åŒä¸€ç”¨æˆ·åœ¨åŒä¸€å¤©å†…åªèƒ½ç­¾åˆ°ä¸€æ¬¡ã€‚

é€šè¿‡ä¸‹é¢çš„ SQL å³å¯æŸ¥è¯¢ç”¨æˆ·çš„ç­¾åˆ°è®°å½•ï¼š

```sql
SELECT signDate FROM user_sign_in 
WHERE userId = ? AND signDate BETWEEN ï¼ŸAND ?;
```

ä¼˜ç‚¹ï¼šåŸç†ç®€å•ï¼Œå®¹æ˜“å®ç°ï¼Œé€‚ç”¨äºç”¨æˆ·é‡è¾ƒå°çš„ç³»ç»Ÿã€‚

ç¼ºç‚¹ï¼šéšç€ç”¨æˆ·é‡å’Œæ•°æ®é‡å¢å¤§ï¼Œå¯¹æ•°æ®åº“çš„å‹åŠ›å¢å¤§ï¼Œç›´æ¥æŸ¥è¯¢æ•°æ®åº“æ€§èƒ½è¾ƒå·®ã€‚é™¤äº†å•æ¥å£çš„å“åº”ä¼šå¢åŠ ï¼Œå¯èƒ½æ•´ä¸ªç³»ç»Ÿéƒ½ä¼šè¢«å…¶æ‹–å®ã€‚

ğŸ’¡ è¯•æƒ³ä¸€ä¸‹ï¼Œæ¯å¤© 1 ä¸‡ä¸ªç”¨æˆ·ç­¾åˆ°ï¼Œ1 ä¸ªæœˆå°± 30 ä¸‡æ¡æ•°æ®ï¼Œ3 ä¸ªæœˆå°±æ¥è¿‘ç™¾ä¸‡çš„æ•°æ®é‡äº†ï¼Œå ç”¨ç¡¬ç›˜ç©ºé—´å¤§æ¦‚ 50 MBã€‚**å­˜å‚¨ 100 ä¸‡ä¸ªç”¨æˆ· 365 å¤©çš„ç­¾åˆ°è®°å½•ï¼Œéœ€è¦ 17.52 GB å·¦å³ã€‚**

#### åç«¯æ–¹æ¡ˆ - åŸºäºç¼“å­˜ Redis Set

å¯ä»¥åˆ©ç”¨å†…å­˜ç¼“å­˜åŠ é€Ÿè¯»å†™ï¼Œå¸¸ç”¨çš„æœ¬åœ°ç¼“å­˜æ˜¯ Caffeineï¼Œåˆ†å¸ƒå¼ç¼“å­˜æ˜¯ Redisã€‚

ç”±äºæ¯ä¸ªç”¨æˆ·ä¼šæœ‰å¤šä¸ªç­¾åˆ°è®°å½•ï¼Œå¾ˆé€‚åˆä½¿ç”¨ Redis çš„ Set ç±»å‹å­˜å‚¨ï¼Œæ¯ä¸ªç”¨æˆ·å¯¹åº”ä¸€ä¸ªé”®ï¼ŒSet å†…çš„æ¯ä¸ªå…ƒç´ ä¸ºç­¾åˆ°çš„å…·ä½“æ—¥æœŸã€‚

Redis Key çš„è®¾è®¡ä¸ºï¼š`user:signins:{userId}`

å…¶ä¸­ï¼š

- user æ˜¯ä¸šåŠ¡é¢†åŸŸå‰ç¼€
- signins æ˜¯å…·ä½“æ“ä½œæˆ–åŠŸèƒ½
- {userId} è¡¨ç¤ºæ¯ä¸ªç”¨æˆ·ï¼Œæ˜¯åŠ¨æ€å€¼

å¦‚æœ Redis è¢«å¤šä¸ªé¡¹ç›®å…¬ç”¨ï¼Œè¿˜å¯ä»¥åœ¨å¼€å¤´å¢åŠ é¡¹ç›®å‰ç¼€åŒºåˆ†ï¼Œæ¯”å¦‚ `mianshiya:user:signins:{userId}`ã€‚

ğŸ’¡ æ‰©å±•çŸ¥è¯†ï¼šRedis é”®è®¾è®¡è§„èŒƒ

- æ˜ç¡®æ€§ï¼šé”®åç§°åº”æ˜ç¡®è¡¨ç¤ºæ•°æ®çš„å«ä¹‰å’Œç»“æ„ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ä½¿ç”¨ `signins` å¯ä»¥æ¸…æ¥šåœ°çŸ¥é“è¿™ä¸ªé”®ä¸ç”¨æˆ·çš„ç­¾åˆ°è®°å½•æœ‰å…³ã€‚
- å±‚æ¬¡ç»“æ„ï¼šä½¿ç”¨å†’å· `:` åˆ†éš”ä¸åŒçš„éƒ¨åˆ†ï¼Œå¯ä»¥ä½¿é”®ç»“æ„åŒ–ï¼Œä¾¿äºç®¡ç†å’ŒæŸ¥è¯¢ã€‚
- å”¯ä¸€æ€§ï¼šç¡®ä¿é”®çš„å”¯ä¸€æ€§ï¼Œé¿å…ä¸åŒæ•°æ®ä½¿ç”¨ç›¸åŒçš„é”®å‰ç¼€ã€‚
- ä¸€è‡´æ€§ï¼šåœ¨æ•´ä¸ªç³»ç»Ÿä¸­ä¿æŒé”®è®¾è®¡çš„ä¸€è‡´æ€§ï¼Œä½¿å¾—ç®¡ç†å’Œç»´æŠ¤å˜å¾—æ›´åŠ ç®€å•ã€‚
- é•¿åº¦ï¼šé¿å…è¿‡é•¿çš„é”®åç§°ï¼Œä»¥é˜²å½±å“æ€§èƒ½å’Œå­˜å‚¨æ•ˆç‡ã€‚

å…·ä½“ç¤ºä¾‹å¦‚ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ Redis å‘½ä»¤è¡Œå·¥å…·æ·»åŠ å€¼åˆ°é›†åˆä¸­ï¼š

```
SADD user:signins:123 "2024-09-01"
SADD user:signins:123 "2024-09-02"
```

ä½¿ç”¨å‘½ä»¤æŸ¥æ‰¾é›†åˆä¸­çš„å€¼ï¼š

```
SMEMBERS user:signins:123
```

å¯ä»¥åˆ©ç”¨å¯è§†åŒ–å·¥å…·æŸ¥çœ‹å’Œç®¡ç† Redisï¼Œæ¯”å¦‚ IDEA è‡ªå¸¦çš„ã€æˆ–è€… [RESP](https://github.com/RedisInsight/RedisDesktopManager)ï¼š

è¯¥æ–¹æ¡ˆçš„ä¼˜ç‚¹ï¼šSet æ•°æ®ç»“æ„å¤©ç„¶æ”¯æŒå»é‡ï¼Œé€‚åˆå­˜å‚¨å’Œæ£€ç´¢æ‰“å¡è®°å½•ã€‚

ç¼ºç‚¹ï¼šä¸Šè¿°è®¾è®¡æ˜¾ç„¶å­˜å‚¨äº†å¾ˆå¤šé‡å¤çš„å­—ç¬¦ä¸²ï¼Œé’ˆå¯¹æµ·é‡æ•°æ®åœºæ™¯ï¼Œéœ€è¦è€ƒè™‘å†…å­˜çš„å ç”¨é‡ã€‚

æ¯”å¦‚ä¸‹åˆ—æ•°æ®ï¼š

```
key = user:signins:123
value = ["2024-09-01", "2024-09-02", "2024-10-01", "2024-10-02"]
```

å…¶ä¸­ï¼Œå¹´ä»½è¢«é‡å¤å­˜å‚¨ã€‚

ä¸ºäº†å‡å°‘å†…å­˜å ç”¨ï¼Œè¿˜å¯ä»¥åœ¨ key ä¸­å¢åŠ æ›´å¤šæ—¥æœŸå±‚çº§ï¼Œæ¯”å¦‚ `user:signins:{year}:{userId}`ã€‚ç¤ºä¾‹å‘½ä»¤å¦‚ä¸‹ï¼š

```json
SADD user:signins:2024:123 "09-01"
SADD user:signins:2024:123 "10-01"
```

è¿™æ ·ä¸€æ¥ï¼Œä¸ä»…èŠ‚çº¦äº†å†…å­˜ï¼Œä¹Ÿä¾¿äºç®¡ç†ï¼Œå¯ä»¥è½»æ¾æŸ¥è¯¢æŸä¸ªç”¨æˆ·åœ¨æŸä¸ªå¹´ä»½çš„ç­¾åˆ°æƒ…å†µã€‚

ğŸ’¡ å­˜å‚¨ **100 ä¸‡ä¸ªç”¨æˆ·** çš„ **365 å¤©** ç­¾åˆ°è®°å½•ï¼Œä½¿ç”¨ Redis é›†åˆç±»å‹æ¥å­˜å‚¨æ¯ä¸ªç”¨æˆ·çš„ç­¾åˆ°ä¿¡æ¯ï¼Œæ¯ä¸ªç”¨æˆ·éœ€è¦å¤§çº¦ **1880 å­—èŠ‚** çš„ç©ºé—´ï¼Œæ€»å…±éœ€è¦å¤§çº¦ **1.88GB** çš„å†…å­˜ç©ºé—´ï¼Œç›¸æ¯”æ•°æ®åº“èŠ‚çº¦äº† 10 å€å·¦å³ã€‚

æœ‰æ²¡æœ‰æ›´èŠ‚çº¦å†…å­˜çš„æ–¹å¼å‘¢ï¼Ÿ

#### åç«¯æ–¹æ¡ˆ - Bitmap ä½å›¾

Bitmap ä½å›¾ï¼Œæ˜¯ä¸€ç§ä½¿ç”¨ä½ï¼ˆbitï¼‰æ¥è¡¨ç¤ºæ•°æ®çš„ **ç´§å‡‘** æ•°æ®ç»“æ„ã€‚æ¯ä¸ªä½å¯ä»¥å­˜å‚¨ä¸¤ä¸ªå€¼ï¼š0 æˆ– 1ï¼Œå¸¸ç”¨äºè¡¨ç¤ºæŸç§çŠ¶æ€æˆ–æ ‡å¿—ã€‚å› ä¸ºæ¯ä¸ªä½ä»…å ç”¨ 1 ä½å†…å­˜ï¼ŒBitmap åœ¨å¤§è§„æ¨¡å­˜å‚¨äºŒå€¼æ•°æ®ï¼ˆå¦‚å¸ƒå°”å€¼ï¼‰æ—¶ï¼Œéå¸¸é«˜æ•ˆä¸”èŠ‚çº¦ç©ºé—´ã€‚

æ ¸å¿ƒæ€æƒ³ï¼šä¸å…¶å­˜å‚¨ç”¨æˆ·ç­¾åˆ°çš„å…·ä½“æ—¥æœŸï¼Œä¸å¦‚å­˜å‚¨ç”¨æˆ·åœ¨ä»Šå¹´çš„ç¬¬ N å¤©æ˜¯å¦ç­¾åˆ°ã€‚

```
2024-01-01 => 1ï¼ˆç¬¬ä¸€å¤©ï¼‰
2024-01-03 => 3ï¼ˆç¬¬ä¸‰å¤©ï¼‰
```

ä½¿ç”¨ä½å›¾ç±»å‹å­˜å‚¨ï¼Œæ¯ä¸ªç”¨æˆ·å¯¹åº”ä¸€ä¸ªé”®ï¼ŒBitmap çš„ **æ¯ä¸€ä½** æ¥è¡¨ç¤ºç”¨æˆ·åœ¨ **æŸä¸€å¤©** æ˜¯å¦æ‰“å¡ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ç­¾åˆ°çš„çŠ¶æ€å¯ä»¥ç”¨ 0 å’Œ 1 è¡¨ç¤ºï¼Œ0 ä»£è¡¨æœªç­¾åˆ°ï¼Œ1 ä»£è¡¨ç­¾åˆ°ã€‚

```
0101 è¡¨ç¤ºç¬¬ 1 å¤©å’Œç¬¬ 3 å¤©å·²ç­¾åˆ°
1010 è¡¨ç¤ºç¬¬ 2 å¤©å’Œç¬¬ 4 å¤©å·²ç­¾åˆ°
```

å¦‚æœä¸ç”¨ Bitmapï¼Œæœ€ä¼ ç»Ÿçš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆè¯•ç€ç”¨ int ç±»å‹æ¥å­˜å‚¨ç­¾åˆ°çŠ¶æ€ï¼š

```
int status = 0; // æœªç­¾åˆ°
int status = 1; // å·²ç­¾åˆ°
```

è€Œ int ç±»å‹å ç”¨çš„ç©ºé—´ä¸º 4 ä¸ªå­—èŠ‚ï¼ˆbyteï¼‰ï¼Œä¸€ä¸ªå­—èŠ‚å  8 ä½ï¼ˆbitï¼‰ï¼Œå³ä¸€ä¸ª int å  32 ä½ã€‚

åœ¨è¿™ç§ä»…å­˜å‚¨äºŒå€¼ï¼ˆ0 æˆ– 1ï¼‰çš„åœºæ™¯ï¼Œå°±å¯ä»¥ä½¿ç”¨ Bitmap ä½å›¾æ¥ä¼˜åŒ–å­˜å‚¨ï¼Œå› ä¸ºä¸€ä¸ª bit å°±å¯ä»¥è¡¨ç¤º 0 å’Œ 1ã€‚

æŠŠ int ä¼˜åŒ–æˆç”¨ bit å­˜å‚¨ï¼Œé‚£ä¹ˆå ç”¨çš„ç©ºé—´å¯ä»¥ä¼˜åŒ– 32 å€ï¼å‡è®¾åŸå…ˆå ç”¨çš„å¤§å°éœ€è¦ 32 Gï¼Œé‚£ä¹ˆæ”¹é€ åä»…éœ€ 1 Gã€‚å¦‚å›¾ï¼š

![image (assets/9xhp1iCinVMTVbL1.webp).png](https://pic.code-nav.cn/post_picture/1601072287388278786/9xhp1iCinVMTVbL1.webp)

è¿™é‡Œéœ€è¦æ³¨æ„ï¼šç°ä»£è®¡ç®—æœºä½“ç³»ç»“æ„é€šå¸¸ä»¥å­—èŠ‚ï¼ˆ8ä½ï¼‰ä½œä¸ºæœ€å°å¯»å€å•ä½ï¼Œé‚£ä¹ˆä¸Šè¿°çš„ bit æ˜¯å¦‚ä½•å­˜å‚¨çš„å‘¢ï¼Ÿ

ç­”æ¡ˆå°±æ˜¯ **æ‰“åŒ…**ã€‚

é€šè¿‡å°†å¤šä¸ª bit æ‰“åŒ…åˆ°ä¸€ä¸ªå­—èŠ‚ï¼ˆæˆ–è€…å…¶ä»–æ›´å¤§çš„æ•°æ®ç±»å‹ï¼Œå¦‚ intã€longï¼‰ä¸­æ¥å®ç°çš„ã€‚æ¯ä¸ªå­—èŠ‚ï¼ˆæˆ–æ•°æ®ç±»å‹ï¼‰è¢«è§†ä¸ºä¸€ä¸ªæ¡¶ï¼Œé‡Œé¢å¯ä»¥å­˜æ”¾è‹¥å¹²ä¸ªå¸ƒå°”å€¼ï¼ˆ0 æˆ– 1ï¼‰ã€‚

å¯¹æ¯ä¸€ä½æ“ä½œæ—¶ï¼Œè¦ä½¿ç”¨ä½è¿ç®—è¿›è¡Œè®¿é—®ï¼Œæ‰€ä»¥ä¸Šè¿°çš„å›¾å®é™…åº”è¯¥æ”¹æˆï¼š

![1733816805411](assets/1733816805411.png)

å¯¹äºåˆ·é¢˜ç­¾åˆ°è®°å½•åœºæ™¯ï¼Œä¸€ä¸ªç”¨æˆ·å­˜å‚¨ä¸€å¹´çš„æ•°æ®ä»…éœ€å ç”¨ 46 å­—èŠ‚ï¼Œå› ä¸º 46 * 8 = 368ï¼Œèƒ½è¦†ç›– 365 å¤©çš„è®°å½•ã€‚é‚£ä¸€ç™¾ä¸‡ç”¨æˆ·ä¹Ÿæ‰å ç”¨ 43.8 MBï¼Œç›¸æ¯”äº Redis Set ç»“æ„èŠ‚çº¦äº† 40 å¤šå€å­˜å‚¨ç©ºé—´ï¼

1000w ä¸ªç”¨æˆ·ä¹Ÿæ‰å ç”¨ 438 MBï¼æ­å–œä½ ï¼Œè®¾è®¡å‡ºäº†ä¸€ä¸ªä½æˆæœ¬æ”¯æŒåƒä¸‡ç”¨æˆ·çš„ç³»ç»Ÿï¼

å½“ç„¶ï¼Œæˆ‘ä»¬æ²¡å¿…è¦è‡ªå·±é€šè¿‡ int ç­‰ç±»å‹å®ç° Bitmapï¼ŒJDK è‡ªå¸¦äº† BitSet ç±»ã€Redis ä¹Ÿæ”¯æŒ Bitmap é«˜çº§æ•°æ®ç»“æ„ã€‚è€ƒè™‘åˆ°é¡¹ç›®çš„åˆ†å¸ƒå¼ã€å¯æ‰©å±•æ€§ï¼Œé‡‡ç”¨ Redis çš„ Bitmap å®ç°ã€‚

Redis Key çš„è®¾è®¡ä¸ºï¼š`user:signins:{å¹´ä»½}:{userId}`

è®¾ç½®æŸä¸€ä¸ª bit å€¼çš„å‘½ä»¤å¦‚ä¸‹ï¼š

```
-- è¡¨ç¤ºç”¨æˆ·åœ¨ç¬¬ 240 å¤©æ‰“å¡
SETBIT user:signins:2024:123 240 1
-- è¡¨ç¤ºç”¨æˆ·åœ¨ç¬¬ 241 å¤©æ‰“å¡
SETBIT user:signins:2024:123 241 1
```

æŸ¥è¯¢æŸä¸€ä¸ª bit å€¼çš„å‘½ä»¤ï¼š

```
GETBIT user:signins:2024:123 240
```

åœ¨ Java ç¨‹åºä¸­ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ Redisson åº“æä¾›çš„ç°æˆçš„ RBitSetï¼Œå¼€å‘æˆæœ¬ä¹Ÿå¾ˆä½ã€‚

è¿™ç§æ–¹æ¡ˆçš„ä¼˜ç‚¹ï¼šå†…å­˜å ç”¨æå°ï¼Œé€‚åˆå¤§è§„æ¨¡ç”¨æˆ·å’Œæ—¥æœŸçš„åœºæ™¯ã€‚

ç¼ºç‚¹ï¼šéœ€è¦ç†Ÿæ‚‰ä½å›¾æ“ä½œï¼Œä¸å¤Ÿç›´è§‚ã€‚

![1733816900843](assets/1733816900843.png)

ä½†è¿™ä¸ªç¼ºç‚¹æ— å…³ç—›ç—’ï¼Œå› æ­¤æœ¬é¡¹ç›®é‡‡ç”¨è¿™ç§æ–¹æ¡ˆå®ç°ã€‚

æ€»ç»“ä¸€ä¸‹ï¼š

- åŸºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œæˆ‘ä»¬é€‰ç”¨ Redis ä¸­é—´ä»¶æ¥å­˜å‚¨ç”¨æˆ·çš„ç­¾åˆ°è®°å½•ã€‚
- åŸºäºç©ºé—´çš„è€ƒè™‘ï¼Œæˆ‘ä»¬é€‰ç”¨ Bitmap æ•°æ®ç»“æ„æ¥å­˜å‚¨ç”¨æˆ·çš„ç­¾åˆ°è®°å½•ã€‚

#### å‰ç«¯æ–¹æ¡ˆ

è¦æ˜ç¡®å‰ç«¯å±•ç¤ºç­¾åˆ°è®°å½•æ—¥å†æ‰€éœ€çš„æ•°æ®ç±»å‹ï¼Œåç«¯æ‰å¥½è®¾è®¡æ¥å£çš„è¿”å›å€¼ï¼Œå› æ­¤æ–¹æ¡ˆè®¾è®¡é˜¶æ®µè¦è€ƒè™‘å…¨é¢ã€‚

å¤æ‚çš„å±•ç¤ºç»„ä»¶è‚¯å®šä¸ç”¨è‡ªå·±å¼€å‘ï¼Œåªè¦æ˜¯å›¾è¡¨ï¼ˆå¯è§†åŒ–ï¼‰ï¼Œå°±å¯ä»¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ Apache ECharts å‰ç«¯å¯è§†åŒ–åº“ï¼Œæœ‰ 3 ç§å¯è¡Œçš„ç»„ä»¶ï¼š

1. åŸºç¡€æ—¥å†å›¾ï¼šhttps://echarts.apache.org/examples/zh/editor.html?c=calendar-simple
2. æ—¥å†çƒ­åŠ›å›¾ï¼šhttps://echarts.apache.org/examples/zh/editor.html?c=calendar-heatmapï¼Œè·Ÿä¸Šä¸€ä¸ªå›¾çš„åŒºåˆ«å°±æ˜¯é¼ æ ‡æ”¾ä¸Šå»å¯ä»¥å±•ç¤ºå…·ä½“çš„çƒ­åŠ›å€¼ï¼Œçƒ­åŠ›å€¼è¶Šé«˜ï¼Œå›¾å—çš„é¢œè‰²è¶Šæ·±ã€‚
3. æ—¥å†å›¾ï¼šhttps://echarts.apache.org/examples/zh/editor.html?c=calendar-charts

æœ¬é¡¹ç›®é€‰æ‹©åŸºç¡€æ—¥å†å›¾å³å¯ï¼Œä¸æ¶‰åŠçƒ­åŠ›æ•°å€¼çš„åŒºåˆ†ï¼ˆåªæœ‰ 0 å’Œ 1 ç­¾åˆ° / æœªç­¾åˆ°çš„åŒºåˆ«ï¼‰ï¼š

```js
visualMap: {
  show: false,
    min: 0,
    max: 1,
    inRange: {
    color: ['#efefef', 'lightgreen']  // é¢œè‰²ä»ç°è‰²åˆ°æµ…ç»¿è‰²
  },
},
```

![1733818206874](assets/1733818206874.png)

### åç«¯å¼€å‘

éœ€è¦å¼€å‘ 2 ä¸ªæ¥å£ï¼š

1. æ·»åŠ åˆ·é¢˜ç­¾åˆ°è®°å½•
2. æŸ¥è¯¢åˆ·é¢˜ç­¾åˆ°è®°å½•

åœ¨æ­¤ä¹‹å‰ï¼Œéœ€è¦å…ˆå¼•å…¥ Redisson ä¾èµ–ï¼Œä»¥å®ç° Bitmap å­˜å‚¨ã€‚

#### 1ã€å¼•å…¥ Redisson

[Redisson](https://github.com/redisson/redisson) æ˜¯ä¸€ä¸ªåŸºäº Redis çš„å¼€æºåˆ†å¸ƒå¼ Java æ•°æ®åº“å®¢æˆ·ç«¯ï¼Œæä¾›äº†ç±»ä¼¼ Java æ ‡å‡†åº“çš„æ•°æ®ç»“æ„ï¼ˆå¦‚ Mapã€Setã€Listã€BitSet ç­‰ï¼‰åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„å®ç°ã€‚å®ƒä¸ä»…æ”¯æŒåŸºæœ¬çš„ Redis æ“ä½œï¼Œè¿˜æä¾›äº†é«˜çº§åŠŸèƒ½ï¼Œå¦‚åˆ†å¸ƒå¼é”ã€åŒæ­¥å™¨ã€é™æµå™¨ã€ç¼“å­˜ç­‰ï¼Œç®€åŒ–äº†åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä½¿ç”¨ Redis è¿›è¡Œæ•°æ®å…±äº«å’Œå¹¶å‘æ§åˆ¶çš„å¤æ‚æ€§ã€‚

![1733818466788](assets/1733818466788.png)

1.åœ¨ pom.xml æ–‡ä»¶ä¸­å¼•å…¥ Redissonï¼š

```xml
<dependency>
  <groupId>org.redisson</groupId>
  <artifactId>redisson</artifactId>
  <version>3.21.0</version>
</dependency>
```

2.åœ¨ config ç›®å½•ä¸‹ç¼–å†™ Redisson å®¢æˆ·ç«¯é…ç½®ç±»ï¼Œä¼šè‡ªåŠ¨è¯»å–é¡¹ç›®ä¸­çš„ Redis é…ç½®ï¼Œåˆå§‹åŒ–å®¢æˆ·ç«¯ Beanã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@Configuration
@ConfigurationProperties(prefix = "spring.redis")
@Data
public class RedissonConfig {

    private String host;

    private Integer port;

    private Integer database;

    private String password;

    @Bean
    public RedissonClient redissonClient() {
        Config config = new Config();
        config.useSingleServer()
        .setAddress("redis://" + host + ":" + port)
        .setDatabase(database)
        .setPassword(password);
        return Redisson.create(config);
    }
}
```

3.é¡¹ç›®çš„ yml é…ç½®æ–‡ä»¶ä¸­è¡¥å…… Redis é…ç½®ï¼Œæ²¡æœ‰å¯†ç å°±å¯ä»¥æ³¨é‡Šæ‰ï¼š

```
# Redis é…ç½®
spring:
  redis:
    database: 0
    host: xxxx
    port: xxx
    timeout: 2000
    password: xxx
```

ç„¶åå°è¯•å¯åŠ¨é¡¹ç›®ã€‚å¦‚æœç”¨çš„æ˜¯ç¼–ç¨‹å¯¼èˆªçš„ä¸‡ç”¨åç«¯æ¨¡æ¿ï¼Œ**è®°å¾—å–æ¶ˆå¯åŠ¨ç±»å¯¹ Redis çš„ç§»é™¤**ã€‚

#### 2ã€æ·»åŠ åˆ·é¢˜ç­¾åˆ°è®°å½•æ¥å£

è§¦å‘æ—¶æœºï¼šå·²ç™»å½•ç”¨æˆ·è¿›å…¥é¢˜ç›®è¯¦æƒ…é¡µæ—¶ï¼Œè°ƒç”¨æ¥å£ï¼Œè§¦å‘ç­¾åˆ°ã€‚

æ¥å£é€»è¾‘ï¼šåˆ¤æ–­ç›®å‰ç”¨æˆ·å½“å¤©æ˜¯å¦ç­¾åˆ°

- å¦‚æœå·²ç­¾åˆ°ï¼Œåˆ™å¿½ç•¥
- å¦‚æœæœªç­¾åˆ°ï¼Œåˆ™åœ¨ Bitmap ä¸­è®¾ç½®è®°å½•

1ï¼‰å› ä¸ºè¯»å†™ Redis ä½¿ç”¨çš„æ˜¯ç›¸åŒçš„ keyï¼Œå¯ä»¥å°†æ‰€æœ‰ Redis çš„ key å•ç‹¬å®šä¹‰æˆå¸¸é‡ï¼Œæ”¾åœ¨ constant ç›®å½•ä¸‹ï¼Œè¿˜å¯ä»¥æä¾›æ‹¼æ¥å®Œæ•´ key çš„æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
public interface RedisConstant {

    /**
     * ç”¨æˆ·ç­¾åˆ°è®°å½•çš„ Redis Key å‰ç¼€
     */
    String USER_SIGN_IN_REDIS_KEY_PREFIX = "user:signins";

    /**
     * è·å–ç”¨æˆ·ç­¾åˆ°è®°å½•çš„ Redis Key
     * @param year å¹´ä»½
     * @param userId ç”¨æˆ· id
     * @return æ‹¼æ¥å¥½çš„ Redis Key
     */
    static String getUserSignInRedisKey(int year, long userId) {
        return String.format("%s:%s:%s", USER_SIGN_IN_REDIS_KEY_PREFIX, year, userId);
    }

}
```

2ï¼‰åœ¨ UserService ä¸­ç¼–å†™æ¥å£ï¼š

```java
/**
 * æ·»åŠ ç”¨æˆ·ç­¾åˆ°è®°å½•
 *
 * @param userId ç”¨æˆ· id
 * @return å½“å‰æ˜¯å¦å·²ç­¾åˆ°æˆåŠŸ
 */
boolean addUserSignIn(long userId);
```

ç¼–å†™å®ç°ç±»ï¼š

```java
/**
 * æ·»åŠ ç”¨æˆ·ç­¾åˆ°è®°å½•
 *
 * @param userId ç”¨æˆ·ç­¾åˆ°
 * @return å½“å‰æ˜¯å¦å·²ç­¾åˆ°æˆåŠŸ
 */
public boolean addUserSignIn(long userId) {
    LocalDate date = LocalDate.now();
    String key = RedisConstant.getUserSignInRedisKey(date.getYear(), userId);
    RBitSet signInBitSet = redissonClient.getBitSet(key);
    // è·å–å½“å‰æ—¥æœŸæ˜¯ä¸€å¹´ä¸­çš„ç¬¬å‡ å¤©ï¼Œä½œä¸ºåç§»é‡ï¼ˆä» 1 å¼€å§‹è®¡æ•°ï¼‰
    int offset = date.getDayOfYear();
    // æ£€æŸ¥å½“å¤©æ˜¯å¦å·²ç»ç­¾åˆ°
    if (!signInBitSet.get(offset)) {
        // å¦‚æœå½“å¤©è¿˜æœªç­¾åˆ°ï¼Œåˆ™è®¾ç½®
        return signInBitSet.set(offset, true);
    }
    // å½“å¤©å·²ç­¾åˆ°
    return true;
}
```

3ï¼‰åœ¨ Controller ä¸­ç¼–å†™ API æ¥å£ï¼š

```java
/**
 * æ·»åŠ ç”¨æˆ·ç­¾åˆ°è®°å½•
 *
 * @param request
 * @return å½“å‰æ˜¯å¦å·²ç­¾åˆ°æˆåŠŸ
 */
@PostMapping("/add/sign_in")
public BaseResponse<Boolean> addUserSignIn(HttpServletRequest request) {
    // å¿…é¡»è¦ç™»å½•æ‰èƒ½ç­¾åˆ°
    User loginUser = userService.getLoginUser(request);
    boolean result = userService.addUserSignIn(loginUser.getId());
    return ResultUtils.success(result);
}
```

ğŸ’¡ æ€è€ƒï¼šè¿™ä¸ªæ¥å£çš„ç­¾åˆ°æ“ä½œèƒ½å¦å¼‚æ­¥æ‰§è¡Œå‘¢ï¼Ÿ

#### 3ã€æŸ¥è¯¢åˆ·é¢˜ç­¾åˆ°è®°å½•æ¥å£

å®ç°æ€è·¯ï¼š

1. é€šè¿‡ userId å’Œå½“å‰å¹´ä»½ä» Redis ä¸­è·å–å¯¹åº”çš„ Bitmap
2. è·å–å½“å‰å¹´ä»½çš„æ€»å¤©æ•°
3. å¾ªç¯å¤©æ•°æ‹¼æ¥æ—¥æœŸï¼Œæ ¹æ®æ—¥æœŸå» Bitmap ä¸­åˆ¤æ–­æ˜¯å¦æœ‰ç­¾åˆ°è®°å½•ï¼Œå¹¶è®°å½•åˆ°æ•°ç»„ä¸­
4. æœ€åï¼Œå°†æ‹¼æ¥å¥½çš„ã€ä¸€å¹´çš„ç­¾åˆ°è®°å½•è¿”å›ç»™å‰ç«¯

1ï¼‰åœ¨ UserService ä¸­å®šä¹‰æ¥å£ï¼š

```java
/**
 * è·å–ç”¨æˆ·æŸä¸ªå¹´ä»½çš„ç­¾åˆ°è®°å½•
 *
 * @param userId ç”¨æˆ· id
 * @param year   å¹´ä»½ï¼ˆä¸ºç©ºè¡¨ç¤ºå½“å‰å¹´ä»½ï¼‰
 * @return ç­¾åˆ°è®°å½•æ˜ å°„
 */
Map<LocalDate, Boolean> getUserSignInRecord(long userId, Integer year);
```

ä¸ºä»€ä¹ˆä½¿ç”¨ Map è€Œä¸æ˜¯ List å‘¢ï¼Ÿä¸‹é¢ä¼šæ­æ™“ç­”æ¡ˆã€‚

2ï¼‰ç¼–å†™å®ç°ç±»ï¼Œä¾æ¬¡è·å–æ¯ä¸€å¤©çš„ç­¾åˆ°çŠ¶æ€ï¼š

```java
@Override
public Map<LocalDate, Boolean> getUserSignInRecord(long userId, Integer year) {
    if (year == null) {
        LocalDate date = LocalDate.now();
        year = date.getYear();
    }
    String key = RedisConstant.getUserSignInRedisKey(year, userId);
    RBitSet signInBitSet = redissonClient.getBitSet(key);
    // LinkedHashMap ä¿è¯æœ‰åº
    Map<LocalDate, Boolean> result = new LinkedHashMap<>();
    // è·å–å½“å‰å¹´ä»½çš„æ€»å¤©æ•°
    int totalDays = Year.of(year).length();
    // ä¾æ¬¡è·å–æ¯ä¸€å¤©çš„ç­¾åˆ°çŠ¶æ€
    for (int dayOfYear = 1; dayOfYear <= totalDays; dayOfYear++) {
        // è·å– keyï¼šå½“å‰æ—¥æœŸ
        LocalDate currentDate = LocalDate.ofYearDay(year, dayOfYear);
        // è·å– valueï¼šå½“å¤©æ˜¯å¦æœ‰åˆ·é¢˜
        boolean hasRecord = signInBitSet.get(dayOfYear);
        // å°†ç»“æœæ”¾å…¥ map
        result.put(currentDate, hasRecord);
    }
    return result;
}
```

æ³¨æ„ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† LinkedHashMap æ¥ä¿è¯äº†é”®å€¼å¯¹æ˜ å°„çš„æœ‰åºæ€§ï¼Œç›¸å½“äºç›´æ¥å¾—åˆ°äº†æ˜ å°„åˆ—è¡¨ï¼Œç¬¦åˆå‰ç«¯è¦æ±‚çš„è¿”å›å€¼æ ¼å¼ã€‚

3ï¼‰ç¼–å†™ Controller æ¥å£ä»£ç ï¼š

```java
/**
 * è·å–ç”¨æˆ·ç­¾åˆ°è®°å½•
 *
 * @param year    å¹´ä»½ï¼ˆä¸ºç©ºè¡¨ç¤ºå½“å‰å¹´ä»½ï¼‰
 * @param request
 * @return ç­¾åˆ°è®°å½•æ˜ å°„
 */
@GetMapping("/get/sign_in")
public BaseResponse<Map<LocalDate, Boolean>> getUserSignInRecord(Integer year, HttpServletRequest request) {
    // å¿…é¡»è¦ç™»å½•æ‰èƒ½è·å–
    User loginUser = userService.getLoginUser(request);
    Map<LocalDate, Boolean> userSignInRecord = userService.getUserSignInRecord(loginUser.getId(), year);
    return ResultUtils.success(userSignInRecord);
}
```

4ï¼‰é€šè¿‡ Swagger æ¥å£æ–‡æ¡£è°ƒç”¨æ¥å£è¿›è¡Œæµ‹è¯•ï¼Œå¾—åˆ°çš„ç¤ºä¾‹ç»“æœå¦‚ä¸‹ï¼š

```json
{2024-01-01=false, 2024-01-02=false, 2024-01-03=false, 2024-01-04=false, 2024-01-05=false, 2024-01-06=false, 2024-01-07=false, 2024-01-08=false, 2024-01-09=false, 2024-01-10=false, 2024-01-11=false, 2024-01-12=false, 2024-01-13=false, 2024-01-14=false, 2024-01-15=false, 2024-01-16=false, 2024-01-17=false, 2024-01-18=false, 2024-01-19=false, 2024-01-20=false, 2024-01-21=false, 2024-01-22=false, 2024-01-23=false, 2024-01-24=false, 2024-01-25=false, 2024-01-26=false, 2024-01-27=false, 2024-01-28=false, 2024-01-29=false,
 2024-01-30=false, 2024-01-31=false, 2024-02-01=false, 2024-02-02=false, 2024-02-03=false, 2024-02-04=false, 2024-02-05=false, 2024-02-06=false, 2024-02-07=false, 2024-02-08=false, 2024-02-09=false, 2024-02-10=false, 2024-02-11=false, 2024-02-12=false, 2024-02-13=false, 2024-02-14=false, 2024-02-15=false, 2024-02-16=false, 2024-02-17=false, 2024-02-18=false, 2024-02-19=false, 2024-02-20=false, 2024-02-21=false, 2024-02-22=false, 2024-02-23=false, 2024-02-24=false, 2024-02-25=false, 2024-02-26=false, 2024-02-27=false, 
 2024-02-28=false, 2024-02-29=false, 2024-03-01=false, 2024-03-02=false, 2024-03-03=false, 2024-03-04=false, 2024-03-05=false, 2024-03-06=false, 2024-03-07=false, 2024-03-08=false, 2024-03-09=false, 2024-03-10=false, 2024-03-11=false, 2024-03-12=false, 2024-03-13=false, 2024-03-14=false, 2024-03-15=false, 2024-03-16=false, 2024-03-17=false, 2024-03-18=false, 2024-03-19=false, 2024-03-20=false, 2024-03-21=false, 2024-03-22=false, 2024-03-23=false, 2024-03-24=false, 2024-03-25=false, 2024-03-26=false, 2024-03-27=false, 
 2024-03-28=false, 2024-03-29=false, 2024-03-30=false, 2024-03-31=false, 2024-04-01=false, 2024-04-02=false, 2024-04-03=false, 2024-04-04=false, 2024-04-05=false, 2024-04-06=false, 2024-04-07=false, 2024-04-08=false, 2024-04-09=false, 2024-04-10=false, 2024-04-11=false, 2024-04-12=false, 2024-04-13=false, 2024-04-14=false, 2024-04-15=false, 2024-04-16=false, 2024-04-17=false, 2024-04-18=false, 2024-04-19=false, 2024-04-20=false, 2024-04-21=false, 2024-04-22=false, 2024-04-23=false, 2024-04-24=false, 2024-04-25=false, 
 2024-04-26=false, 2024-04-27=false, 2024-04-28=false, 2024-04-29=false, 2024-04-30=false, 2024-05-01=false, 2024-05-02=false, 2024-05-03=false, 2024-05-04=false, 2024-05-05=false, 2024-05-06=false, 2024-05-07=false, 2024-05-08=false, 2024-05-09=false, 2024-05-10=false, 2024-05-11=false, 2024-05-12=false, 2024-05-13=false, 2024-05-14=false, 2024-05-15=false, 2024-05-16=false, 2024-05-17=false, 2024-05-18=false, 2024-05-19=false, 2024-05-20=false, 2024-05-21=false, 2024-05-22=false, 2024-05-23=false, 2024-05-24=false, 
 2024-05-25=false, 2024-05-26=false, 2024-05-27=false, 2024-05-28=false, 2024-05-29=false, 2024-05-30=false, 2024-05-31=false, 2024-06-01=false, 2024-06-02=false, 2024-06-03=false, 2024-06-04=false, 2024-06-05=false, 2024-06-06=false, 2024-06-07=false, 2024-06-08=false, 2024-06-09=false, 2024-06-10=false, 2024-06-11=false, 2024-06-12=false, 2024-06-13=false, 2024-06-14=false, 2024-06-15=false, 2024-06-16=false, 2024-06-17=false, 2024-06-18=false, 2024-06-19=false, 2024-06-20=false, 2024-06-21=false, 2024-06-22=false, 
2024-06-23=false, 2024-06-24=false, 2024-06-25=false, 2024-06-26=false, 2024-06-27=false, 2024-06-28=false, 2024-06-29=false, 2024-06-30=false, 2024-07-01=false, 2024-07-02=false, 2024-07-03=false, 2024-07-04=false, 2024-07-05=false, 2024-07-06=false, 2024-07-07=false, 2024-07-08=false, 2024-07-09=false, 2024-07-10=false, 2024-07-11=false, 2024-07-12=false, 2024-07-13=false, 2024-07-14=false, 2024-07-15=false, 2024-07-16=false, 2024-07-17=false, 2024-07-18=false, 2024-07-19=false, 2024-07-20=false, 2024-07-21=false, 
2024-07-22=false, 2024-07-23=false, 2024-07-24=false, 2024-07-25=false, 2024-07-26=false, 2024-07-27=false, 2024-07-28=false, 2024-07-29=false, 2024-07-30=false, 2024-07-31=false, 2024-08-01=false, 2024-08-02=false, 2024-08-03=false, 2024-08-04=false, 2024-08-05=false, 2024-08-06=false, 2024-08-07=false, 2024-08-08=false, 2024-08-09=false, 2024-08-10=false, 2024-08-11=false, 2024-08-12=false, 2024-08-13=true, 2024-08-14=true, 2024-08-15=false, 2024-08-16=false, 2024-08-17=false, 2024-08-18=false, 2024-08-19=false, 
2024-08-20=false, 2024-08-21=false, 2024-08-22=false, 2024-08-23=false, 2024-08-24=false, 2024-08-25=false, 2024-08-26=false, 2024-08-27=false, 2024-08-28=false, 2024-08-29=false, 2024-08-30=false, 2024-08-31=false, 2024-09-01=false, 2024-09-02=false, 2024-09-03=false, 2024-09-04=false, 2024-09-05=false, 2024-09-06=false, 2024-09-07=false, 2024-09-08=false, 2024-09-09=false, 2024-09-10=false, 2024-09-11=false, 2024-09-12=false, 2024-09-13=false, 2024-09-14=false, 2024-09-15=false, 2024-09-16=false, 2024-09-17=false, 
2024-09-18=false, 2024-09-19=false, 2024-09-20=false, 2024-09-21=false, 2024-09-22=false, 2024-09-23=false, 2024-09-24=false, 2024-09-25=false, 2024-09-26=false, 2024-09-27=false, 2024-09-28=false, 2024-09-29=false, 2024-09-30=false, 2024-10-01=false, 2024-10-02=false, 2024-10-03=false, 2024-10-04=false, 2024-10-05=false, 2024-10-06=false, 2024-10-07=false, 2024-10-08=false, 2024-10-09=false, 2024-10-10=false, 2024-10-11=false, 2024-10-12=false, 2024-10-13=false, 2024-10-14=false, 2024-10-15=false, 2024-10-16=false,
2024-10-17=false, 2024-10-18=false, 2024-10-19=false, 2024-10-20=false, 2024-10-21=false, 2024-10-22=false, 2024-10-23=false, 2024-10-24=false, 2024-10-25=false, 2024-10-26=false, 2024-10-27=false, 2024-10-28=false, 2024-10-29=false, 2024-10-30=false, 2024-10-31=false, 2024-11-01=false, 2024-11-02=false, 2024-11-03=false, 2024-11-04=false, 2024-11-05=false, 2024-11-06=false, 2024-11-07=false, 2024-11-08=false, 2024-11-09=false, 2024-11-10=false, 2024-11-11=false, 2024-11-12=false, 2024-11-13=false, 2024-11-14=false, 
2024-11-15=false, 2024-11-16=false, 2024-11-17=false, 2024-11-18=false, 2024-11-19=false, 2024-11-20=false, 2024-11-21=false, 2024-11-22=false, 2024-11-23=false, 2024-11-24=false, 2024-11-25=false, 2024-11-26=false, 2024-11-27=false, 2024-11-28=false, 2024-11-29=false, 2024-11-30=false, 2024-12-01=false, 2024-12-02=false, 2024-12-03=false, 2024-12-04=false, 2024-12-05=false, 2024-12-06=false, 2024-12-07=false, 2024-12-08=false, 2024-12-09=false, 2024-12-10=false, 2024-12-11=false, 2024-12-12=false, 2024-12-13=false, 
2024-12-14=false, 2024-12-15=false, 2024-12-16=false, 2024-12-17=false, 2024-12-18=false, 2024-12-19=false, 2024-12-20=false, 2024-12-21=false, 2024-12-22=false, 2024-12-23=false, 2024-12-24=false, 2024-12-25=false, 2024-12-26=false, 2024-12-27=false, 2024-12-28=false, 2024-12-29=false, 2024-12-30=false, 2024-12-31=false}
```

### æ€§èƒ½ä¼˜åŒ–

ç›®å‰çš„ä»£ç é€»è¾‘è™½ç„¶çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œä½†æ˜¯å­˜åœ¨å¾ˆå¤§çš„ä¼˜åŒ–ç©ºé—´ï¼

#### 1ã€åˆ¤æ–­æ¯å¤©æ˜¯å¦åˆ·é¢˜é€»è¾‘ä¼˜åŒ–

ä¸çŸ¥é“å¤§å®¶å¯¹ä¸Šé¢è¿™æ®µä»£ç æ˜¯å¦æ•æ„Ÿï¼Ÿå¾ªç¯å†…éƒ¨éœ€è¦åˆ¤æ–­å½“å¤©æ˜¯å¦æœ‰åˆ·é¢˜ï¼Œå®é™…ä¸Šæ¯æ¬¡åˆ¤æ–­éƒ½ä¼šå»ä¸ Redis äº¤äº’ï¼Œä¸€ä¸ªå¾ªç¯éœ€è¦äº¤äº’ 365 æ¬¡ Redisï¼Œæ•ˆç‡æä½ï¼

```java
// ä¾æ¬¡è·å–æ¯ä¸€å¤©çš„ç­¾åˆ°çŠ¶æ€
for (int dayOfYear = 1; dayOfYear <= totalDays; dayOfYear++) {
    // è·å– keyï¼šå½“å‰æ—¥æœŸ
    LocalDate currentDate = LocalDate.ofYearDay(year, dayOfYear);
    // è·å– valueï¼šå½“å¤©æ˜¯å¦æœ‰åˆ·é¢˜
    boolean hasRecord = signInBitSet.get(dayOfYear);
    // å°†ç»“æœæ”¾å…¥ map
    result.put(currentDate, hasRecord);
}
```

å…·ä½“æ¥è¯´ï¼Œ`signInBitSet` æ˜¯é€šè¿‡ Redisson å®¢æˆ·ç«¯ä¸ Redis äº¤äº’çš„ `RBitSet` å¯¹è±¡ï¼Œè€Œ `RBitSet.get(int bitIndex)` è¿™ä¸ªæ–¹æ³•ä¼šè§¦å‘ä¸€æ¬¡ Redis è¯·æ±‚æ¥è·å–å¯¹åº”ä½çš„å€¼ï¼Œå¹¶æ²¡æœ‰åœ¨æœ¬åœ°åšç¼“å­˜ã€‚

é€šè¿‡ WireShark ç­‰æŠ“åŒ…å·¥å…·å¯ä»¥çœ‹åˆ°ï¼Œå®¢æˆ·ç«¯å‘äº†ä¸€å¤§å †è¯·æ±‚ç»™ redis å®ä¾‹ã€‚ä»”ç»†è§‚å¯Ÿå³ä¸‹è§’çš„æŠ“åŒ…æ•°æ®ï¼Œå¯ä»¥çœ‹åˆ°æ‰§è¡Œçš„æ“ä½œï¼š

```

```

å› æ­¤ï¼Œæˆ‘ä»¬åœ¨å¾ªç¯å¤–ç¼“å­˜ä¸€ä¸‹ Bitmap çš„æ•°æ®ï¼Œå³å¯å¤§å¤§æå‡è¿™ä¸ªæ–¹æ³•çš„æ•ˆç‡ï¼š

```java
// åŠ è½½ BitSet åˆ°å†…å­˜ä¸­ï¼Œé¿å…åç»­è¯»å–æ—¶å‘é€å¤šæ¬¡è¯·æ±‚
BitSet bitSet = signInBitSet.asBitSet();
```

å¾ªç¯å†…éƒ¨ä½¿ç”¨ `bitSet.get` å³å¯ï¼š

```java
// è·å– valueï¼šå½“å¤©æ˜¯å¦æœ‰åˆ·é¢˜
boolean hasRecord = bitSet.get(dayOfYear);
```

#### 2ã€åˆ·é¢˜è®°å½•è¿”å›å€¼ä¼˜åŒ–

ä»ç¤ºä¾‹ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ° **ä¼ è¾“çš„æ•°æ®è¾ƒå¤šã€è®¡ç®—æ—¶é—´è€—æ—¶ã€å¸¦å®½å ç”¨å¤šã€æ•ˆç‡ä½**ã€‚

å®é™…ä¸Šæ²¡å¿…è¦å®Œå…¨ç»„è£…å¥½æ•°æ®ä¼ è¾“ç»™å‰ç«¯ï¼Œä»…éœ€å‘Šè¯‰å‰ç«¯å“ªå¤©æœ‰åˆ·é¢˜å°±è¡Œï¼ˆå¤§éƒ¨åˆ†åŒå­¦ä¸å¯èƒ½ä¸€å¹´ 365 å¤©æ¯å¤©éƒ½åˆ·é¢˜ï¼‰ï¼Œè¿™æ ·èƒ½å¤§å¤§å‡å°‘ä¼ è¾“çš„æ•°æ®é‡ä»¥åŠåç«¯æœåŠ¡çš„ CPU å ç”¨ï¼Œå°†éƒ¨åˆ†è®¡ç®—å‹åŠ›å‡æ‘Šåˆ°ç”¨æˆ·çš„å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨èº«ä¸Šï¼‰ã€‚

ä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š

```java
@Override
public List<Integer> getUserSignInRecord(long userId, Integer year) {
    if (year == null) {
        LocalDate date = LocalDate.now();
        year = date.getYear();
    }
    String key = RedisConstant.getUserSignInRedisKey(year, userId);
    RBitSet signInBitSet = redissonClient.getBitSet(key);
    // åŠ è½½ BitSet åˆ°å†…å­˜ä¸­ï¼Œé¿å…åç»­è¯»å–æ—¶å‘é€å¤šæ¬¡è¯·æ±‚
    BitSet bitSet = signInBitSet.asBitSet();
    // ç»Ÿè®¡ç­¾åˆ°çš„æ—¥æœŸ
    List<Integer> dayList = new ArrayList<>();
    // è·å–å½“å‰å¹´ä»½çš„æ€»å¤©æ•°
    int totalDays = Year.of(year).length();
    // ä¾æ¬¡è·å–æ¯ä¸€å¤©çš„ç­¾åˆ°çŠ¶æ€
    for (int dayOfYear = 1; dayOfYear <= totalDays; dayOfYear++) {
        // è·å– valueï¼šå½“å¤©æ˜¯å¦æœ‰åˆ·é¢˜
        boolean hasRecord = bitSet.get(dayOfYear);
        if (hasRecord) {
          dayList.add(dayOfYear);
        }
    }
    return dayList;
}
```

#### 3ã€è®¡ç®—ä¼˜åŒ–

ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å¾ªç¯æ¥éå†æ‰€æœ‰å¹´ä»½ï¼Œè€Œå¾ªç¯æ˜¯éœ€è¦æ¶ˆè€— CPU è®¡ç®—èµ„æºçš„ã€‚

åœ¨ Java ä¸­çš„ `BitSet` ç±»ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `nextSetBit(int fromIndex)` å’Œ `nextClearBit(int fromIndex)` æ–¹æ³•æ¥è·å–ä»æŒ‡å®šç´¢å¼•å¼€å§‹çš„ä¸‹ä¸€ä¸ª **å·²è®¾ç½®ï¼ˆå³ä¸º 1ï¼‰** æˆ– **æœªè®¾ç½®ï¼ˆå³ä¸º 0ï¼‰** çš„ä½ã€‚

ä¸»è¦æ˜¯ 2 ä¸ªæ–¹æ³•ï¼š

- `nextSetBit(int fromIndex)`ï¼šä» `fromIndex` å¼€å§‹ï¼ˆåŒ…æ‹¬ `fromIndex` æœ¬èº«ï¼‰å¯»æ‰¾ä¸‹ä¸€ä¸ªè¢«è®¾ç½®ä¸º 1 çš„ä½ã€‚å¦‚æœæ‰¾åˆ°äº†ï¼Œè¿”å›è¯¥ä½çš„ç´¢å¼•ï¼›å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè¿”å› -1ã€‚
- `nextClearBit(int fromIndex)`ï¼šä» `fromIndex` å¼€å§‹ï¼ˆåŒ…æ‹¬ `fromIndex` æœ¬èº«ï¼‰å¯»æ‰¾ä¸‹ä¸€ä¸ªä¸º 0 çš„ä½ã€‚å¦‚æœæ‰¾åˆ°äº†ï¼Œè¿”å›è¯¥ä½çš„ç´¢å¼•ï¼›å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè¿”å›ä¸€ä¸ªå¤§çš„æ•´æ•°å€¼ã€‚

ä½¿ç”¨ nextSetBitï¼Œå¯ä»¥è·³è¿‡æ— æ„ä¹‰çš„å¾ªç¯æ£€æŸ¥ï¼Œé€šè¿‡ä½è¿ç®—æ¥è·å–è¢«è®¾ç½®ä¸º 1 çš„ä½ç½®ï¼Œæ€§èƒ½æ›´é«˜ã€‚

ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ï¼š

```java
@Override
public List<Integer> getUserSignInRecord(long userId, Integer year) {
    if (year == null) {
        LocalDate date = LocalDate.now();
        year = date.getYear();
    }
    String key = RedisConstant.getUserSignInRedisKey(year, userId);
    RBitSet signInBitSet = redissonClient.getBitSet(key);
    // åŠ è½½ BitSet åˆ°å†…å­˜ä¸­ï¼Œé¿å…åç»­è¯»å–æ—¶å‘é€å¤šæ¬¡è¯·æ±‚
    BitSet bitSet = signInBitSet.asBitSet();
    // ç»Ÿè®¡ç­¾åˆ°çš„æ—¥æœŸ
    List<Integer> dayList = new ArrayList<>();
    // ä»ç´¢å¼• 0 å¼€å§‹æŸ¥æ‰¾ä¸‹ä¸€ä¸ªè¢«è®¾ç½®ä¸º 1 çš„ä½
    int index = bitSet.nextSetBit(0);
    while (index >= 0) {
        dayList.add(index);
        // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªè¢«è®¾ç½®ä¸º 1 çš„ä½
        index = bitSet.nextSetBit(index + 1);
    }
    return dayList;
}
```

å¾—åˆ°ç»“æœç¤ºä¾‹å¦‚ä¸‹ï¼š

```
[1, 226]
```

æ³¨æ„ï¼Œéœ€è¦åŒæ­¥ä¿®æ”¹ Controller æ¥å£è¿”å›å€¼ã€‚

#### ä¼˜åŒ–å°ç»“

æœ¬åŠŸèƒ½çš„æ€§èƒ½ä¼˜åŒ–ä¹Ÿæ˜¯æœ‰ä»£è¡¨æ€§çš„ï¼Œæ€»ç»“å‡ºæ¥å‡ ä¸ªå®ç”¨ä¼˜åŒ–æ€è·¯ï¼š

1. å‡å°‘ç½‘ç»œè¯·æ±‚æˆ–è°ƒç”¨æ¬¡æ•°
2. å‡å°‘æ¥å£ä¼ è¾“æ•°æ®çš„ä½“ç§¯
3. å‡å°‘å¾ªç¯å’Œè®¡ç®—
4. é€šè¿‡å®¢æˆ·ç«¯è®¡ç®—å‡å°‘æœåŠ¡ç«¯çš„å‹åŠ›

#### æ‰©å±•

å¤§å®¶å¯ä»¥é€šè¿‡ JMeter å‹æµ‹å·¥å…·æ¥æµ‹è¯•ä¸‹æ€§èƒ½ä¼˜åŒ–å‰åçš„æ¥å£ QPS å’Œå¹³å‡å“åº”æ—¶é•¿ï¼Œåº”è¯¥ä¼šæœ‰æ„å¤–ä¹‹å–œã€‚